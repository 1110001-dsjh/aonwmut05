<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網頁書籤管理器 (現代介面)</title>
    <!-- 引入 Tailwind CSS CDN 以加速樣式開發 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 設定 Tailwind 配置，使用 Inter 字體和自定義顏色/陰影
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // 自定義主色調為活力藍紫色
                        'primary-dark': '#5850EC', // 較深的藍紫
                        'primary-light': '#7F79F9', // 較淺的藍紫
                        'bg-main': '#F2F6FA', // 輕微的淺灰藍背景
                        'text-default': '#1f2937', // 深灰色文字
                    },
                    boxShadow: {
                        // 自定義更柔和和多層次的陰影
                        '3xl': '0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'soft-lg': '0 10px 15px -3px rgba(88, 80, 236, 0.15), 0 4px 6px -2px rgba(88, 80, 236, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* 設定中文字體，並套用新的背景色 */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #F2F6FA; 
        }
        /* 自定義主要按鈕動畫 */
        .btn-primary {
            transition: all 0.3s ease;
            transform: translateZ(0); 
        }
        .btn-primary:hover {
            opacity: 0.95;
            transform: scale(1.02);
            box-shadow: 0 8px 15px rgba(88, 80, 236, 0.3);
        }
        
        /* 自定義滾動條樣式 */
        #bookmark-list::-webkit-scrollbar,
        #bookmark-table-container::-webkit-scrollbar {
            width: 8px;
        }
        #bookmark-list::-webkit-scrollbar-thumb,
        #bookmark-table-container::-webkit-scrollbar-thumb {
            background-color: #a3a3a3; /* 較深的灰色 */
            border-radius: 4px;
        }
        #bookmark-list::-webkit-scrollbar-track,
        #bookmark-table-container::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        /* 表格排序圖標的樣式 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: color 0.15s;
        }
        .sortable-header:hover {
            color: #5850EC; /* primary-dark */
        }
        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            opacity: 0.5;
        }
        .active-sort .sort-icon {
            opacity: 1;
            color: #5850EC;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-bg-main">

    <!-- 主容器：使用新的大圓角和深度陰影 -->
    <div class="max-w-6xl mx-auto bg-white shadow-3xl rounded-3xl p-6 md:p-10">

        <!-- 標題區域 (簡化並美化) -->
        <header class="mb-8 border-b pb-4 border-gray-100">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-default mb-1">我的網頁書籤 🔖</h1>
            <p class="text-lg text-gray-500">高效管理您的數位資源。</p>
        </header>

        <!-- 新增書籤表單 (使用新的卡片風格) -->
        <section id="add-bookmark-section" class="mb-8 p-6 md:p-8 bg-white shadow-soft-lg border border-primary-light/10 rounded-3xl transition duration-300 hover:shadow-lg">
            <h2 class="text-2xl font-bold text-primary-dark mb-4 border-b pb-2 border-primary-light/30">新增書籤</h2>
            <form id="bookmark-form" class="space-y-4">
                
                <div>
                    <label for="url-input" class="block text-sm font-medium text-gray-700">網址 (URL)</label>
                    <div class="flex space-x-3 mt-1">
                        <input type="url" id="url-input" required placeholder="例如：https://webshare.dsjh.tn.edu.tw/"
                               class="block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                        
                        <button type="button" id="autofill-button" 
                                class="flex-shrink-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 transform hover:scale-[1.03]">
                            自動填充
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">提示：頁面標題是從網址主機名稱提取的建議值。</p>
                </div>
                
                <div>
                    <label for="title-input" class="block text-sm font-medium text-gray-700">書籤名稱 (Title)</label>
                    <input type="text" id="title-input" required placeholder="例如：Webshare"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                </div>

                <div>
                    <label for="category-input" class="block text-sm font-medium text-gray-700">分類/標籤 (Category)</label>
                    <input type="text" id="category-input" placeholder="例如：工作、開發、閱讀 (可選)"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                </div>

                <div id="message-box" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>
                
                <button type="submit"
                        class="btn-primary w-full sm:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-soft-lg text-sm font-medium rounded-xl text-white bg-gradient-to-r from-primary-dark to-primary-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-light transform">
                    儲存書籤
                </button>
            </form>
        </section>
        
        <!-- 匯入/匯出功能區塊 (使用新的卡片風格) -->
        <section class="mb-8 p-6 md:p-8 bg-white shadow-soft-lg border border-gray-200 rounded-3xl transition duration-300 hover:shadow-lg">
            <h2 class="text-2xl font-bold text-text-default mb-4 border-b pb-2 border-gray-100">📂 資料管理 (匯入/匯出)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="export-button"
                        class="w-full inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-md text-sm font-medium rounded-xl text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    匯出 JSON 備份
                </button>
                
                <div class="flex items-center space-x-2">
                    <label for="import-file" class="cursor-pointer w-full inline-flex items-center justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark transition duration-200 transform hover:scale-[1.02]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        匯入 JSON
                    </label>
                    <input type="file" id="import-file" accept=".json" class="hidden">
                </div>
            </div>
        </section>

        <!-- 書籤列表與總表容器 -->
        <section>
            <h2 class="text-2xl font-bold text-text-default mb-4">書籤總覽</h2>

            <!-- 視圖切換按鈕 (使用主色調) -->
            <div class="flex mb-6 border-b border-gray-200">
                <button id="view-list-btn" onclick="toggleView('list')" class="px-4 py-3 text-sm font-medium border-b-2 border-primary-dark text-primary-dark transition duration-150">
                    卡片列表
                </button>
                <button id="view-table-btn" onclick="toggleView('table')" class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150">
                    表格總表
                </button>
            </div>


            <!-- 列表視圖：搜尋、篩選和排序區域 -->
            <div id="list-controls" class="mb-6 space-y-3 p-4 bg-gray-50 rounded-xl">
                
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" id="search-input" placeholder="輸入關鍵字搜尋名稱或網址..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    
                    <div class="relative">
                        <label for="category-filter" class="sr-only">分類篩選</label>
                        <select id="category-filter"
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-inner appearance-none bg-white focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>

                    <div class="relative">
                        <label for="sort-select" class="sr-only">排序方式</label>
                        <select id="sort-select"
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-inner appearance-none bg-white focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                            <option value="date-desc">日期 (最新優先)</option>
                            <option value="date-asc">日期 (最舊優先)</option>
                            <option value="title-asc">名稱 (A-Z)</option>
                            <option value="title-desc">名稱 (Z-A)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 卡片列表視圖容器 -->
            <div id="bookmark-list-view">
                <ul id="bookmark-list" class="space-y-3 max-h-[50vh] overflow-y-auto">
                    <li id="empty-state-list" class="text-center p-8 text-gray-500 italic bg-gray-50 rounded-xl">
                        目前沒有任何書籤。請在上方新增您的第一個書籤！
                    </li>
                </ul>
            </div>

            <!-- 表格總表視圖容器 -->
            <div id="bookmark-table-view" class="hidden">
                <div class="flex justify-end mb-4">
                    <button id="export-csv-btn"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-200 transform hover:scale-[1.02]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        匯出 CSV (Google Sheets)
                    </button>
                </div>
                
                <div id="bookmark-table-container" class="overflow-x-auto max-h-[60vh] border border-gray-200 rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" 
                                    data-sort-key="title" data-sort-dir="asc">
                                    名稱
                                    <span class="sort-icon">&#x2195;</span>
                                </th>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" 
                                    data-sort-key="url" data-sort-dir="none">
                                    網址 (URL)
                                    <span class="sort-icon">&#x2195;</span>
                                </th>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32" 
                                    data-sort-key="category" data-sort-dir="none">
                                    分類
                                    <span class="sort-icon">&#x2195;</span>
                                </th>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40 active-sort" 
                                    data-sort-key="date" data-sort-dir="desc">
                                    建立日期
                                    <span class="sort-icon">&#x2193;</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="bookmark-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                    <p id="empty-state-table" class="hidden text-center p-8 text-gray-500 italic bg-white">
                        找不到符合條件的書籤。
                    </p>
                </div>
            </div>

        </section>

    </div>

    <script>
        // 設定 localStorage 儲存的鍵名
        const STORAGE_KEY = 'webBookmarks';
        const DEFAULT_CATEGORY = '未分類';
        
        // ** 驗證常數 **
        const MAX_TITLE_LENGTH = 100;
        const MAX_CATEGORY_LENGTH = 50;
        
        // 全域書籤陣列，用於儲存所有書籤
        let allBookmarks = []; 
        let currentView = 'list'; // 'list' 或 'table'
        let currentTableSort = { key: 'date', dir: 'desc' }; // 表格排序狀態

        // 獲取 DOM 元素
        const bookmarkForm = document.getElementById('bookmark-form');
        const urlInput = document.getElementById('url-input');
        const titleInput = document.getElementById('title-input');
        const categoryInput = document.getElementById('category-input'); 
        
        // 視圖和列表元素
        const bookmarkListView = document.getElementById('bookmark-list-view');
        const bookmarkTableView = document.getElementById('bookmark-table-view');
        const bookmarkList = document.getElementById('bookmark-list');
        const bookmarkTableBody = document.getElementById('bookmark-table-body');
        const emptyStateList = document.getElementById('empty-state-list');
        const emptyStateTable = document.getElementById('empty-state-table');

        // 控制項
        const messageBox = document.getElementById('message-box');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const sortSelect = document.getElementById('sort-select'); 
        const autofillButton = document.getElementById('autofill-button');
        const listControls = document.getElementById('list-controls');

        // 匯入/匯出按鈕
        const exportButton = document.getElementById('export-button');
        const importFile = document.getElementById('import-file'); 
        const exportCsvButton = document.getElementById('export-csv-btn');
        
        // 表格標頭
        const tableHeaders = document.querySelectorAll('#bookmark-table-view th.sortable-header');


        /**
         * 將 UNIX 時間戳轉換為 YYYY-MM-DD HH:MM 格式字串
         * @param {number} timestamp UNIX 時間戳
         * @returns {string} 格式化的日期時間字串
         */
        function formatTimestamp(timestamp) {
            if (timestamp === 0) return '歷史資料'; 
            
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        /**
         * 顯示訊息框
         * @param {string} message 訊息內容
         * @param {string} type 訊息類型 ('success' 或 'error')
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); 
        }

        /**
         * 產生一個唯一的 ID
         * @returns {string} 唯一的 ID
         */
        function generateId() {
            return typeof crypto !== 'undefined' && crypto.randomUUID 
                ? crypto.randomUUID() 
                : Date.now().toString();
        }

        /**
         * 獲取當前日期的 YYYY-MM-DD 格式字串
         * @returns {string} 格式化的日期字串
         */
        function getFormattedDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 根據排序類型對書籤陣列進行排序
         * @param {Array} bookmarks 待排序的書籤陣列
         * @param {string} sortType 排序類型字串 (key-dir 格式)
         * @returns {Array} 已排序的書籤陣列
         */
        function sortBookmarks(bookmarks, sortType) {
            return bookmarks.sort((a, b) => {
                const [key, dir] = sortType.split('-');
                let result = 0;

                switch (key) {
                    case 'date': 
                        // 日期排序
                        result = a.createdAt - b.createdAt;
                        break;
                    case 'title':
                    case 'category':
                    case 'url':
                        // 字母排序 (使用 localeCompare 進行中文排序)
                        const valA = a[key] || '';
                        const valB = b[key] || '';
                        result = valA.localeCompare(valB, 'zh-TW', { sensitivity: 'base' });
                        break;
                    default:
                        result = b.createdAt - a.createdAt; // 預設為最新優先
                        break;
                }
                
                // 根據方向決定升序或降序
                return dir === 'desc' ? -result : result;
            });
        }


        /**
         * 從 localStorage 載入書籤，並為舊資料或空欄位補上預設值
         */
        function loadBookmarks() {
            try {
                const storedBookmarks = localStorage.getItem(STORAGE_KEY);
                let bookmarks = storedBookmarks ? JSON.parse(storedBookmarks) : [];
                
                let needsUpdate = false;
                bookmarks = bookmarks.map(bookmark => {
                    if (!bookmark.id) {
                        bookmark.id = generateId();
                        needsUpdate = true;
                    }
                    if (!bookmark.category || bookmark.category.trim() === '') {
                        bookmark.category = DEFAULT_CATEGORY;
                        needsUpdate = true;
                    }
                    if (!bookmark.createdAt) {
                        bookmark.createdAt = 0; 
                        needsUpdate = true;
                    }
                    return bookmark;
                });

                if (needsUpdate) {
                    saveBookmarks(bookmarks);
                }

                return bookmarks;

            } catch (error) {
                console.error("載入書籤失敗:", error);
                showMessage("無法載入書籤資料，可能是儲存資料損壞。", 'error');
                return [];
            }
        }

        /**
         * 將書籤陣列儲存到 localStorage
         */
        function saveBookmarks(bookmarks) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bookmarks));
            } catch (error) {
                console.error("儲存書籤失敗:", error);
                showMessage("無法儲存書籤資料，瀏覽器儲存空間可能已滿。", 'error');
            }
        }

        /**
         * 填充分類篩選器下拉選單
         */
        function populateCategoryFilter() {
            const currentFilterValue = categoryFilter.value;
            
            const categories = allBookmarks.map(b => b.category);
            const uniqueCategories = [DEFAULT_CATEGORY, ...new Set(categories)]
                .filter(c => c && c.trim() !== '') 
                .sort();

            categoryFilter.innerHTML = ''; 
            
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = '所有分類';
            categoryFilter.appendChild(allOption);

            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            if (currentFilterValue) {
                categoryFilter.value = currentFilterValue;
            }
        }

        /**
         * 根據篩選、排序器的值處理 allBookmarks 並重新渲染兩個視圖
         */
        function filterAndRender() {
            const query = searchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value.trim();
            
            // 決定排序類型：如果當前是表格視圖，則使用表格的排序狀態；否則使用下拉選單
            const sortType = currentView === 'table' 
                ? `${currentTableSort.key}-${currentTableSort.dir}`
                : sortSelect.value;
            
            let bookmarksToRender = allBookmarks;

            let isFiltering = false;

            // 步驟 1: 分類過濾
            if (selectedCategory !== '') {
                bookmarksToRender = bookmarksToRender.filter(b => b.category === selectedCategory);
                isFiltering = true;
            }

            // 步驟 2: 關鍵字過濾
            if (query) {
                isFiltering = true;
                bookmarksToRender = bookmarksToRender.filter(b => 
                    b.title.toLowerCase().includes(query) ||
                    b.url.toLowerCase().includes(query)
                );
            }
            
            // 步驟 3: 排序
            bookmarksToRender = sortBookmarks(bookmarksToRender, sortType);
            
            // 步驟 4: 渲染兩個視圖
            renderBookmarks(bookmarksToRender, isFiltering); // 卡片列表
            renderTable(bookmarksToRender, isFiltering);     // 表格總表
        }
        
        /**
         * 渲染書籤列表到 DOM (卡片模式)
         */
        function renderBookmarks(bookmarksToRender, isFiltering = false) {
            bookmarkList.innerHTML = '';

            if (bookmarksToRender.length === 0) {
                emptyStateList.classList.remove('hidden');
                emptyStateList.textContent = isFiltering 
                    ? '找不到符合條件的書籤。' 
                    : '目前沒有任何書籤。請在上方新增您的第一個書籤！';
                bookmarkList.appendChild(emptyStateList);
                return;
            }

            emptyStateList.classList.add('hidden');

            bookmarksToRender.forEach(bookmark => {
                const id = bookmark.id;
                const displayCategory = bookmark.category || DEFAULT_CATEGORY;
                
                const listItem = document.createElement('li');
                listItem.id = `bookmark-${id}`; 
                // 更新卡片樣式：更圓潤、更柔和的陰影和輕微的懸停縮放
                listItem.className = 'p-5 bg-white border border-gray-100 rounded-xl shadow-md hover:shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.005]';
                
                // --- 顯示模式 (Display View) ---
                const displayDiv = document.createElement('div');
                displayDiv.id = `display-view-${id}`;
                displayDiv.className = 'flex items-start justify-between';

                const encodedTitle = bookmark.title.replace(/"/g, '&quot;');
                const encodedUrl = bookmark.url.replace(/"/g, '&quot;');
                
                const linkContent = `
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="flex items-center space-x-2 mb-1">
                            <a href="${encodedUrl}" target="_blank" rel="noopener noreferrer" 
                               class="text-lg font-medium text-primary-dark truncate hover:text-primary-light transition duration-150">
                                ${bookmark.title}
                            </a>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 shadow-sm">
                                ${displayCategory}
                            </span>
                        </div>
                        <span class="text-sm text-gray-500 truncate block">${bookmark.url}</span>
                        <span class="text-xs text-gray-400 mt-1 block">建立於: ${formatTimestamp(bookmark.createdAt)}</span>
                    </div>
                `;
                displayDiv.innerHTML = linkContent;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-2 flex-shrink-0 pt-1';
                
                const editButton = document.createElement('button');
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                                          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-7.5 7.5a1 1 0 00-.288.815l-.483 2.93a1 1 0 00.187.892l.707.707a1 1 0 00.707 0l.707-.707a1 1 0 00.207-.584l.412-2.146a1 1 0 00-.207-.75l-2.121-2.121z" />
                                        </svg>`;
                editButton.title = '編輯';
                editButton.className = 'p-2 rounded-full hover:bg-indigo-50 transition duration-150 ease-in-out';
                editButton.addEventListener('click', () => {
                    toggleEditMode(id, true);
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                        </svg>`;
                deleteButton.title = '刪除';
                deleteButton.className = 'p-2 rounded-full hover:bg-red-50 transition duration-150 ease-in-out';
                deleteButton.addEventListener('click', () => {
                    deleteBookmark(id);
                });

                buttonContainer.appendChild(editButton);
                buttonContainer.appendChild(deleteButton);
                displayDiv.appendChild(buttonContainer);
                
                listItem.appendChild(displayDiv);

                // --- 編輯模式 (Edit View) ---
                const editForm = document.createElement('form');
                editForm.id = `edit-form-${id}`;
                editForm.className = 'space-y-3 hidden pt-3'; 
                editForm.onsubmit = (e) => { e.preventDefault(); updateBookmark(e, id); };
                
                editForm.innerHTML = `
                    <div class="flex space-x-2">
                        <input type="text" id="edit-title-${id}" value="${encodedTitle}" required 
                               placeholder="書籤名稱 (最多 ${MAX_TITLE_LENGTH} 字元)" class="w-1/2 px-3 py-1 border border-gray-300 rounded-xl text-sm focus:ring-primary-dark focus:border-primary-dark">
                        <input type="text" id="edit-category-${id}" value="${displayCategory.replace(/"/g, '&quot;')}" 
                               placeholder="分類/標籤 (最多 ${MAX_CATEGORY_LENGTH} 字元)" class="w-1/2 px-3 py-1 border border-gray-300 rounded-xl text-sm focus:ring-primary-dark focus:border-primary-dark">
                    </div>
                    <div>
                        <label for="edit-url-${id}" class="sr-only">網址</label>
                        <input type="url" id="edit-url-${id}" value="${encodedUrl}" required 
                               placeholder="網址 (必須包含 http:// 或 https://)" class="w-full px-3 py-1 border border-gray-300 rounded-xl text-sm focus:ring-primary-dark focus:border-primary-dark">
                    </div>
                    <div class="flex justify-end space-x-2 pt-2">
                        <button type="button" onclick="window.toggleEditMode('${id}', false)" 
                                class="px-3 py-1 text-sm font-medium text-gray-700 border border-gray-300 rounded-full hover:bg-gray-100 transition duration-150 transform hover:scale-[1.05]">
                            取消
                        </button>
                        <button type="submit" 
                                class="px-3 py-1 text-sm font-medium text-white bg-primary-dark rounded-full hover:bg-primary-light transition duration-150 transform hover:scale-[1.05]">
                            儲存修改
                        </button>
                    </div>
                `;
                
                listItem.appendChild(editForm);
                bookmarkList.appendChild(listItem);
            });
        }
        
        /**
         * 渲染書籤總表到 DOM (表格模式)
         */
        function renderTable(bookmarksToRender, isFiltering = false) {
            bookmarkTableBody.innerHTML = '';
            
            // 處理表格空白狀態
            const tableContainer = document.getElementById('bookmark-table-container');
            if (bookmarksToRender.length === 0) {
                emptyStateTable.classList.remove('hidden');
                tableContainer.classList.add('flex', 'flex-col', 'items-center', 'justify-center');
                return;
            }

            emptyStateTable.classList.add('hidden');
            tableContainer.classList.remove('flex', 'flex-col', 'items-center', 'justify-center');

            bookmarksToRender.forEach((bookmark, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50 transition duration-100' : 'bg-gray-50 hover:bg-gray-100 transition duration-100';

                // 書籤名稱 (Title)
                const titleTd = document.createElement('td');
                titleTd.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs';
                titleTd.innerHTML = `<a href="${bookmark.url}" target="_blank" rel="noopener noreferrer" 
                                       class="text-primary-dark hover:text-primary-light transition duration-150">${bookmark.title}</a>`;
                tr.appendChild(titleTd);
                
                // 網址 (URL)
                const urlTd = document.createElement('td');
                urlTd.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs';
                urlTd.textContent = bookmark.url;
                tr.appendChild(urlTd);
                
                // 分類 (Category)
                const categoryTd = document.createElement('td');
                categoryTd.className = 'px-4 py-3 whitespace-nowrap text-xs text-gray-700 w-32';
                categoryTd.textContent = bookmark.category || DEFAULT_CATEGORY;
                tr.appendChild(categoryTd);

                // 建立日期 (CreatedAt)
                const dateTd = document.createElement('td');
                dateTd.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500 w-40';
                dateTd.textContent = formatTimestamp(bookmark.createdAt);
                tr.appendChild(dateTd);

                bookmarkTableBody.appendChild(tr);
            });
        }

        /**
         * 處理表格標頭點擊事件 (表格排序)
         */
        function handleTableSort(e) {
            const th = e.currentTarget;
            const key = th.dataset.sortKey;
            let dir = th.dataset.sortDir;

            // 移除所有標頭的 active 狀態
            tableHeaders.forEach(header => {
                header.classList.remove('active-sort');
                header.querySelector('.sort-icon').innerHTML = '&#x2195;'; // 預設雙箭頭
                header.dataset.sortDir = 'none'; // 重置其他標頭的方向
            });

            // 判斷新的排序方向
            if (key === currentTableSort.key) {
                // 如果點擊的是同一欄，切換方向
                dir = currentTableSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果點擊的是新的一欄，預設為降序 (desc) 或依 key 設定
                dir = key === 'title' || key === 'category' || key === 'url' ? 'asc' : 'desc';
            }

            // 更新表格排序狀態
            currentTableSort = { key, dir };

            // 更新標頭的視覺效果
            th.classList.add('active-sort');
            th.dataset.sortDir = dir;
            th.querySelector('.sort-icon').innerHTML = dir === 'asc' ? '&#x2191;' : '&#x2193;'; // 顯示單向箭頭
            
            // 重新篩選和渲染 (filterAndRender 會根據 currentTableSort 進行排序)
            filterAndRender();
        }


        /**
         * 將所有書籤匯出為 CSV 格式 (適用於 Google Sheets 或 Excel)
         */
        function exportToCSV() {
            if (allBookmarks.length === 0) {
                showMessage("書籤列表為空，沒有資料可供匯出。", 'error');
                return;
            }

            // CSV 標頭
            const headers = ["Title", "URL", "Category", "CreatedAt"];
            const csvRows = [];
            csvRows.push(headers.join(',')); // 加入標頭

            allBookmarks.forEach(bookmark => {
                // 處理可能包含逗號或引號的字串，並確保使用標準格式
                const escapeCSV = (str) => {
                    if (!str) return '""';
                    // 移除換行符並將雙引號替換為兩個雙引號，然後用雙引號包住整個字串
                    let s = String(str).replace(/\n/g, ' ').replace(/"/g, '""');
                    return `"${s}"`;
                };

                const row = [
                    escapeCSV(bookmark.title),
                    escapeCSV(bookmark.url),
                    escapeCSV(bookmark.category || DEFAULT_CATEGORY),
                    escapeCSV(formatTimestamp(bookmark.createdAt))
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const dataBlob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            // 建立下載連結
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_export_${Date.now()}.csv`;
            
            // 觸發點擊並清除
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`成功匯出 ${allBookmarks.length} 個書籤到 ${a.download}。`, 'success');
        }


        /**
         * 切換視圖模式
         * @param {string} view 'list' 或 'table'
         */
        window.toggleView = function(view) {
            currentView = view;
            
            // 更新按鈕視覺效果
            const listBtn = document.getElementById('view-list-btn');
            const tableBtn = document.getElementById('view-table-btn');

            if (view === 'list') {
                bookmarkListView.classList.remove('hidden');
                bookmarkTableView.classList.add('hidden');
                listControls.classList.remove('hidden');

                listBtn.classList.add('border-primary-dark', 'text-primary-dark');
                listBtn.classList.remove('text-gray-500', 'hover:border-gray-300', 'border-transparent');
                
                tableBtn.classList.remove('border-primary-dark', 'text-primary-dark');
                tableBtn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                
                // 切換回列表視圖時，將排序狀態恢復到下拉選單的值
                sortSelect.value = `${currentTableSort.key}-${currentTableSort.dir}`; 

            } else {
                bookmarkListView.classList.add('hidden');
                bookmarkTableView.classList.remove('hidden');
                listControls.classList.add('hidden'); // 表格視圖不需要列表的篩選/排序控制項

                tableBtn.classList.add('border-primary-dark', 'text-primary-dark');
                tableBtn.classList.remove('text-gray-500', 'hover:border-gray-300', 'border-transparent');
                
                listBtn.classList.remove('border-primary-dark', 'text-primary-dark');
                listBtn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');

                // 確保表格排序狀態生效
            }

            // 重新渲染，以應用新的排序狀態 (即使視圖切換，排序也可能改變)
            filterAndRender(); 
        }

        // 綁定編輯模式切換 (保持原有的 window scope 函數)
        window.toggleEditMode = function(id, isEditing) {
            const displayDiv = document.getElementById(`display-view-${id}`);
            const editForm = document.getElementById(`edit-form-${id}`);

            if (displayDiv && editForm) {
                if (isEditing) {
                    displayDiv.classList.add('hidden');
                    editForm.classList.remove('hidden');
                } else {
                    displayDiv.classList.remove('hidden');
                    editForm.classList.add('hidden');
                }
            }
        }
        
        // --- 核心 CRUD 功能 ---
        function addBookmark(e) {
            e.preventDefault();

            const url = urlInput.value.trim();
            const title = titleInput.value.trim();
            let category = categoryInput.value.trim();
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showMessage('網址必須以 http:// 或 https:// 開頭');
                return;
            }
            if (title.length > MAX_TITLE_LENGTH || title === '') {
                showMessage(`書籤名稱太長或為空，請勿超過 ${MAX_TITLE_LENGTH} 個字元。`);
                return;
            }
            if (category.length > MAX_CATEGORY_LENGTH) {
                showMessage(`分類名稱太長，請勿超過 ${MAX_CATEGORY_LENGTH} 個字元。`);
                return;
            }

            if (category === '') {
                category = DEFAULT_CATEGORY;
            }

            const isDuplicate = allBookmarks.some(b => b.url === url);
            if (isDuplicate) {
                showMessage('此網址的書籤已經存在！');
                return;
            }

            const newBookmark = {
                id: generateId(),
                title: title,
                url: url,
                category: category,
                createdAt: Date.now()
            };

            allBookmarks.push(newBookmark);
            saveBookmarks(allBookmarks);
            
            populateCategoryFilter();
            filterAndRender();

            bookmarkForm.reset();
            showMessage('書籤新增成功！', 'success');
        }

        function updateBookmark(e, id) {
            const newTitle = document.getElementById(`edit-title-${id}`).value.trim();
            const newUrl = document.getElementById(`edit-url-${id}`).value.trim();
            let newCategory = document.getElementById(`edit-category-${id}`).value.trim();

            if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
                showMessage('更新失敗：網址必須以 http:// 或 https:// 開頭');
                return;
            }
            if (newTitle.length > MAX_TITLE_LENGTH || newTitle === '') {
                showMessage(`更新失敗：書籤名稱太長或為空，請勿超過 ${MAX_TITLE_LENGTH} 個字元。`);
                return;
            }
            if (newCategory.length > MAX_CATEGORY_LENGTH) {
                showMessage(`更新失敗：分類名稱太長，請勿超過 ${MAX_CATEGORY_LENGTH} 個字元。`);
                return;
            }

            if (newCategory === '') {
                newCategory = DEFAULT_CATEGORY;
            }

            let updated = false;

            const newBookmarks = allBookmarks.map(bookmark => {
                if (bookmark.id === id) {
                    const isOtherDuplicate = allBookmarks.some(b => b.url === newUrl && b.id !== id);
                    if (isOtherDuplicate) {
                        showMessage('更新失敗：新的網址與現有其他書籤重複！');
                        updated = false;
                        return bookmark; 
                    }
                    
                    bookmark.title = newTitle;
                    bookmark.url = newUrl;
                    bookmark.category = newCategory; 
                    updated = true;
                }
                return bookmark;
            });
            allBookmarks = newBookmarks; 

            if (updated) {
                saveBookmarks(allBookmarks);
                populateCategoryFilter(); 
                filterAndRender(); 
                showMessage('書籤已成功更新。', 'success');
            } else {
                toggleEditMode(id, false);
            }
        }

        function deleteBookmark(idToDelete) {
            const updatedBookmarks = allBookmarks.filter(bookmark => bookmark.id !== idToDelete);

            if (updatedBookmarks.length !== allBookmarks.length) {
                allBookmarks = updatedBookmarks; 
                saveBookmarks(allBookmarks);
                populateCategoryFilter(); 
                filterAndRender(); 
                showMessage('書籤已成功刪除。', 'success');
            }
        }
        
        // --- 自動填充和匯入/匯出功能 (保持原有邏輯) ---
        function autoFillDetails() {
            const url = urlInput.value.trim();
            if (url === '' || (!url.startsWith('http://') && !url.startsWith('https://'))) {
                showMessage('請先輸入一個有效的網址！', 'error');
                return;
            }

            categoryInput.value = getFormattedDate();
            showMessage(`分類已設為當前日期: ${categoryInput.value}`, 'success');
            
            titleInput.value = "正在嘗試提取名稱...";
            
            setTimeout(() => {
                try {
                    const urlObject = new URL(url);
                    let hostname = urlObject.hostname;
                    hostname = hostname.replace(/^www\./i, '');
                    let titleSuggestion = hostname.split('.')[0]; 

                    if (titleSuggestion.trim() === '') {
                        titleSuggestion = `[網址解析失敗] 請手動輸入`;
                    } else {
                         titleSuggestion = titleSuggestion.charAt(0).toUpperCase() + titleSuggestion.slice(1);
                    }

                    titleInput.value = titleSuggestion;
                    showMessage("網址名稱已從 URL 成功提取。", 'success');
                    
                } catch (e) {
                    titleInput.value = `[格式錯誤] 請手動校正或檢查網址`;
                    showMessage("網址標題自動填充失敗（網址格式錯誤）。", 'error');
                }
            }, 500); 
        }

        function exportBookmarks() {
            if (allBookmarks.length === 0) {
                showMessage("書籤列表為空，沒有資料可供匯出。", 'error');
                return;
            }

            const dataStr = JSON.stringify(allBookmarks, null, 2); 
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_export_${Date.now()}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`成功匯出 ${allBookmarks.length} 個書籤到 ${a.download}。`, 'success');
        }

        function handleImportFile(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    processImportedData(importedData);
                } catch (error) {
                    console.error("解析 JSON 失敗:", error);
                    showMessage('匯入失敗：檔案格式不正確或不是有效的 JSON 格式。', 'error');
                }
            };
            reader.readAsText(file);
        }

        function processImportedData(importedData) {
            if (!Array.isArray(importedData)) {
                showMessage('匯入失敗：JSON 內容不是一個書籤陣列。', 'error');
                return;
            }

            let importCount = 0;
            let duplicateCount = 0;
            const existingUrls = new Set(allBookmarks.map(b => b.url));
            const newBookmarks = [];

            importedData.forEach(item => {
                if (item && item.title && item.url) {
                    const cleanUrl = item.url.trim();
                    
                    if (existingUrls.has(cleanUrl)) {
                        duplicateCount++;
                        return;
                    }
                    
                    if (item.title.length > MAX_TITLE_LENGTH || (item.category && item.category.length > MAX_CATEGORY_LENGTH)) {
                         console.warn("略過匯入項目: 資料長度超過限制。", item);
                         return;
                    }

                    const newBookmark = {
                        id: generateId(),
                        title: item.title,
                        url: cleanUrl,
                        category: (item.category && item.category.trim() !== '') ? item.category : DEFAULT_CATEGORY,
                        createdAt: item.createdAt || 0
                    };
                    
                    newBookmarks.push(newBookmark);
                    existingUrls.add(cleanUrl);
                    importCount++;
                } else {
                    console.warn("略過無效的匯入項目:", item);
                }
            });

            if (importCount > 0) {
                allBookmarks = [...allBookmarks, ...newBookmarks]; 
                saveBookmarks(allBookmarks);
                populateCategoryFilter(); 
                filterAndRender(); 
                showMessage(`成功匯入 ${importCount} 個書籤。已略過 ${duplicateCount} 個重複項目。`, 'success');
            } else if (duplicateCount > 0) {
                 showMessage(`匯入完成，但所有項目皆為重複，共略過 ${duplicateCount} 個重複項目。`, 'error');
            } else {
                showMessage('匯入失敗：檔案中找不到有效的書籤資料。', 'error');
            }
            
            importFile.value = '';
        }
        
        /**
         * 初始化應用程式：載入資料並設定事件監聽器
         */
        function initializeApp() {
            // 1. 載入資料並設定全域陣列
            allBookmarks = loadBookmarks();
            
            // 2. 填充分類篩選器
            populateCategoryFilter();
            
            // 3. 初始渲染 (預設為列表視圖)
            filterAndRender(); 
            window.toggleView('list');

            // 4. 綁定主要事件監聽器
            bookmarkForm.addEventListener('submit', addBookmark);
            searchInput.addEventListener('input', filterAndRender);
            categoryFilter.addEventListener('change', filterAndRender);
            // 列表排序下拉選單改變時，重設表格排序狀態並渲染
            sortSelect.addEventListener('change', () => {
                currentTableSort = { key: 'date', dir: 'desc' }; // 重置表格排序
                filterAndRender();
            }); 
            
            // 5. 綁定匯入/匯出事件監聽器
            exportButton.addEventListener('click', exportBookmarks);
            importFile.addEventListener('change', handleImportFile); 
            exportCsvButton.addEventListener('click', exportToCSV); // NEW: 匯出 CSV

            // 6. 綁定自動填充按鈕事件
            autofillButton.addEventListener('click', autoFillDetails);

            // 7. 綁定表格標頭排序事件 (NEW)
            tableHeaders.forEach(th => {
                th.addEventListener('click', handleTableSort);
            });
        }

        // 初始化：頁面載入時載入並渲染書籤列表
        window.onload = initializeApp;

    </script>

</body>
</html>