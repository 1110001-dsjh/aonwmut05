<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²é æ›¸ç±¤ç®¡ç†å™¨ (ç¾ä»£ä»‹é¢)</title>
    <!-- å¼•å…¥ Tailwind CSS CDN ä»¥åŠ é€Ÿæ¨£å¼é–‹ç™¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // è¨­å®š Tailwind é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«”å’Œè‡ªå®šç¾©é¡è‰²/é™°å½±
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // è‡ªå®šç¾©ä¸»è‰²èª¿ç‚ºæ´»åŠ›è—ç´«è‰²
                        'primary-dark': '#5850EC', // è¼ƒæ·±çš„è—ç´«
                        'primary-light': '#7F79F9', // è¼ƒæ·ºçš„è—ç´«
                        'bg-main': '#F2F6FA', // è¼•å¾®çš„æ·ºç°è—èƒŒæ™¯
                        'text-default': '#1f2937', // æ·±ç°è‰²æ–‡å­—
                    },
                    boxShadow: {
                        // è‡ªå®šç¾©æ›´æŸ”å’Œå’Œå¤šå±¤æ¬¡çš„é™°å½±
                        '3xl': '0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'soft-lg': '0 10px 15px -3px rgba(88, 80, 236, 0.15), 0 4px 6px -2px rgba(88, 80, 236, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* è¨­å®šä¸­æ–‡å­—é«”ï¼Œä¸¦å¥—ç”¨æ–°çš„èƒŒæ™¯è‰² */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #F2F6FA; 
        }
        /* è‡ªå®šç¾©ä¸»è¦æŒ‰éˆ•å‹•ç•« */
        .btn-primary {
            transition: all 0.3s ease;
            transform: translateZ(0); 
        }
        .btn-primary:hover {
            opacity: 0.95;
            transform: scale(1.02);
            box-shadow: 0 8px 15px rgba(88, 80, 236, 0.3);
        }
        
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        #bookmark-list::-webkit-scrollbar,
        #bookmark-table-container::-webkit-scrollbar {
            width: 8px;
        }
        #bookmark-list::-webkit-scrollbar-thumb,
        #bookmark-table-container::-webkit-scrollbar-thumb {
            background-color: #a3a3a3; /* è¼ƒæ·±çš„ç°è‰² */
            border-radius: 4px;
        }
        #bookmark-list::-webkit-scrollbar-track,
        #bookmark-table-container::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        /* è¡¨æ ¼æ’åºåœ–æ¨™çš„æ¨£å¼ */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: color 0.15s;
        }
        .sortable-header:hover {
            color: #5850EC; /* primary-dark */
        }
        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            opacity: 0.5;
        }
        .active-sort .sort-icon {
            opacity: 1;
            color: #5850EC;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-bg-main">

    <!-- ä¸»å®¹å™¨ï¼šä½¿ç”¨æ–°çš„å¤§åœ“è§’å’Œæ·±åº¦é™°å½± -->
    <div class="max-w-6xl mx-auto bg-white shadow-3xl rounded-3xl p-6 md:p-10">

        <!-- æ¨™é¡Œå€åŸŸ (ç°¡åŒ–ä¸¦ç¾åŒ–) -->
        <header class="mb-8 border-b pb-4 border-gray-100">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-text-default mb-1">æˆ‘çš„ç¶²é æ›¸ç±¤ ğŸ”–</h1>
            <p class="text-lg text-gray-500">é«˜æ•ˆç®¡ç†æ‚¨çš„æ•¸ä½è³‡æºã€‚</p>
        </header>

        <!-- æ–°å¢æ›¸ç±¤è¡¨å–® (ä½¿ç”¨æ–°çš„å¡ç‰‡é¢¨æ ¼) -->
        <section id="add-bookmark-section" class="mb-8 p-6 md:p-8 bg-white shadow-soft-lg border border-primary-light/10 rounded-3xl transition duration-300 hover:shadow-lg">
            <h2 class="text-2xl font-bold text-primary-dark mb-4 border-b pb-2 border-primary-light/30">æ–°å¢æ›¸ç±¤</h2>
            <form id="bookmark-form" class="space-y-4">
                
                <div>
                    <label for="url-input" class="block text-sm font-medium text-gray-700">ç¶²å€ (URL)</label>
                    <div class="flex space-x-3 mt-1">
                        <input type="url" id="url-input" required placeholder="ä¾‹å¦‚ï¼šhttps://webshare.dsjh.tn.edu.tw/"
                               class="block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                        
                        <button type="button" id="autofill-button" 
                                class="flex-shrink-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 transform hover:scale-[1.03]">
                            è‡ªå‹•å¡«å……
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">æç¤ºï¼šé é¢æ¨™é¡Œæ˜¯å¾ç¶²å€ä¸»æ©Ÿåç¨±æå–çš„å»ºè­°å€¼ã€‚</p>
                </div>
                
                <div>
                    <label for="title-input" class="block text-sm font-medium text-gray-700">æ›¸ç±¤åç¨± (Title)</label>
                    <input type="text" id="title-input" required placeholder="ä¾‹å¦‚ï¼šWebshare"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                </div>

                <div>
                    <label for="category-input" class="block text-sm font-medium text-gray-700">åˆ†é¡/æ¨™ç±¤ (Category)</label>
                    <input type="text" id="category-input" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œã€é–‹ç™¼ã€é–±è®€ (å¯é¸)"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                </div>

                <div id="message-box" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>
                
                <button type="submit"
                        class="btn-primary w-full sm:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-soft-lg text-sm font-medium rounded-xl text-white bg-gradient-to-r from-primary-dark to-primary-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-light transform">
                    å„²å­˜æ›¸ç±¤
                </button>
            </form>
        </section>
        
        <!-- åŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½å€å¡Š (ä½¿ç”¨æ–°çš„å¡ç‰‡é¢¨æ ¼) -->
        <section class="mb-8 p-6 md:p-8 bg-white shadow-soft-lg border border-gray-200 rounded-3xl transition duration-300 hover:shadow-lg">
            <h2 class="text-2xl font-bold text-text-default mb-4 border-b pb-2 border-gray-100">ğŸ“‚ è³‡æ–™ç®¡ç† (åŒ¯å…¥/åŒ¯å‡º)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="export-button"
                        class="w-full inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-md text-sm font-medium rounded-xl text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    åŒ¯å‡º JSON å‚™ä»½
                </button>
                
                <div class="flex items-center space-x-2">
                    <label for="import-file" class="cursor-pointer w-full inline-flex items-center justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark transition duration-200 transform hover:scale-[1.02]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        åŒ¯å…¥ JSON
                    </label>
                    <input type="file" id="import-file" accept=".json" class="hidden">
                </div>
            </div>
        </section>

        <!-- æ›¸ç±¤åˆ—è¡¨èˆ‡ç¸½è¡¨å®¹å™¨ -->
        <section>
            <h2 class="text-2xl font-bold text-text-default mb-4">æ›¸ç±¤ç¸½è¦½</h2>

            <!-- è¦–åœ–åˆ‡æ›æŒ‰éˆ• (ä½¿ç”¨ä¸»è‰²èª¿) -->
            <div class="flex mb-6 border-b border-gray-200">
                <button id="view-list-btn" onclick="toggleView('list')" class="px-4 py-3 text-sm font-medium border-b-2 border-primary-dark text-primary-dark transition duration-150">
                    å¡ç‰‡åˆ—è¡¨
                </button>
                <button id="view-table-btn" onclick="toggleView('table')" class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150">
                    è¡¨æ ¼ç¸½è¡¨
                </button>
            </div>


            <!-- åˆ—è¡¨è¦–åœ–ï¼šæœå°‹ã€ç¯©é¸å’Œæ’åºå€åŸŸ -->
            <div id="list-controls" class="mb-6 space-y-3 p-4 bg-gray-50 rounded-xl">
                
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—æœå°‹åç¨±æˆ–ç¶²å€..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    
                    <div class="relative">
                        <label for="category-filter" class="sr-only">åˆ†é¡ç¯©é¸</label>
                        <select id="category-filter"
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-inner appearance-none bg-white focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>

                    <div class="relative">
                        <label for="sort-select" class="sr-only">æ’åºæ–¹å¼</label>
                        <select id="sort-select"
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg shadow-inner appearance-none bg-white focus:ring-primary-dark focus:border-primary-dark transition duration-150 ease-in-out">
                            <option value="date-desc">æ—¥æœŸ (æœ€æ–°å„ªå…ˆ)</option>
                            <option value="date-asc">æ—¥æœŸ (æœ€èˆŠå„ªå…ˆ)</option>
                            <option value="title-asc">åç¨± (A-Z)</option>
                            <option value="title-desc">åç¨± (Z-A)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¡ç‰‡åˆ—è¡¨è¦–åœ–å®¹å™¨ -->
            <div id="bookmark-list-view">
                <ul id="bookmark-list" class="space-y-3 max-h-[50vh] overflow-y-auto">
                    <li id="empty-state-list" class="text-center p-8 text-gray-500 italic bg-gray-50 rounded-xl">
                        ç›®å‰æ²’æœ‰ä»»ä½•æ›¸ç±¤ã€‚è«‹åœ¨ä¸Šæ–¹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ›¸ç±¤ï¼
                    </li>
                </ul>
            </div>

            <!-- è¡¨æ ¼ç¸½è¡¨è¦–åœ–å®¹å™¨ -->
            <div id="bookmark-table-view" class="hidden">
                <div class="flex justify-end mb-4">
                    <button id="export-csv-btn"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-200 transform hover:scale-[1.02]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        åŒ¯å‡º CSV (Google Sheets)
                    </button>
                </div>
                
                <div id="bookmark-table-container" class="overflow-x-auto max-h-[60vh] border border-gray-200 rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" 
                                    data-sort-key="title" data-sort-dir="asc">
                                    åç¨±
                                    <span class="sort-icon">&#x2195;</span>
                                </th>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" 
                                    data-sort-key="url" data-sort-dir="none">
                                    ç¶²å€ (URL)
                                    <span class="sort-icon">&#x2195;</span>
                                </th>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32" 
                                    data-sort-key="category" data-sort-dir="none">
                                    åˆ†é¡
                                    <span class="sort-icon">&#x2195;</span>
                                </th>
                                <th scope="col" class="sortable-header px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40 active-sort" 
                                    data-sort-key="date" data-sort-dir="desc">
                                    å»ºç«‹æ—¥æœŸ
                                    <span class="sort-icon">&#x2193;</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="bookmark-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                    <p id="empty-state-table" class="hidden text-center p-8 text-gray-500 italic bg-white">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸ç±¤ã€‚
                    </p>
                </div>
            </div>

        </section>

    </div>

    <script>
        // è¨­å®š localStorage å„²å­˜çš„éµå
        const STORAGE_KEY = 'webBookmarks';
        const DEFAULT_CATEGORY = 'æœªåˆ†é¡';
        
        // ** é©—è­‰å¸¸æ•¸ **
        const MAX_TITLE_LENGTH = 100;
        const MAX_CATEGORY_LENGTH = 50;
        
        // å…¨åŸŸæ›¸ç±¤é™£åˆ—ï¼Œç”¨æ–¼å„²å­˜æ‰€æœ‰æ›¸ç±¤
        let allBookmarks = []; 
        let currentView = 'list'; // 'list' æˆ– 'table'
        let currentTableSort = { key: 'date', dir: 'desc' }; // è¡¨æ ¼æ’åºç‹€æ…‹

        // ç²å– DOM å…ƒç´ 
        const bookmarkForm = document.getElementById('bookmark-form');
        const urlInput = document.getElementById('url-input');
        const titleInput = document.getElementById('title-input');
        const categoryInput = document.getElementById('category-input'); 
        
        // è¦–åœ–å’Œåˆ—è¡¨å…ƒç´ 
        const bookmarkListView = document.getElementById('bookmark-list-view');
        const bookmarkTableView = document.getElementById('bookmark-table-view');
        const bookmarkList = document.getElementById('bookmark-list');
        const bookmarkTableBody = document.getElementById('bookmark-table-body');
        const emptyStateList = document.getElementById('empty-state-list');
        const emptyStateTable = document.getElementById('empty-state-table');

        // æ§åˆ¶é …
        const messageBox = document.getElementById('message-box');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const sortSelect = document.getElementById('sort-select'); 
        const autofillButton = document.getElementById('autofill-button');
        const listControls = document.getElementById('list-controls');

        // åŒ¯å…¥/åŒ¯å‡ºæŒ‰éˆ•
        const exportButton = document.getElementById('export-button');
        const importFile = document.getElementById('import-file'); 
        const exportCsvButton = document.getElementById('export-csv-btn');
        
        // è¡¨æ ¼æ¨™é ­
        const tableHeaders = document.querySelectorAll('#bookmark-table-view th.sortable-header');


        /**
         * å°‡ UNIX æ™‚é–“æˆ³è½‰æ›ç‚º YYYY-MM-DD HH:MM æ ¼å¼å­—ä¸²
         * @param {number} timestamp UNIX æ™‚é–“æˆ³
         * @returns {string} æ ¼å¼åŒ–çš„æ—¥æœŸæ™‚é–“å­—ä¸²
         */
        function formatTimestamp(timestamp) {
            if (timestamp === 0) return 'æ­·å²è³‡æ–™'; 
            
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        /**
         * é¡¯ç¤ºè¨Šæ¯æ¡†
         * @param {string} message è¨Šæ¯å…§å®¹
         * @param {string} type è¨Šæ¯é¡å‹ ('success' æˆ– 'error')
         */
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); 
        }

        /**
         * ç”¢ç”Ÿä¸€å€‹å”¯ä¸€çš„ ID
         * @returns {string} å”¯ä¸€çš„ ID
         */
        function generateId() {
            return typeof crypto !== 'undefined' && crypto.randomUUID 
                ? crypto.randomUUID() 
                : Date.now().toString();
        }

        /**
         * ç²å–ç•¶å‰æ—¥æœŸçš„ YYYY-MM-DD æ ¼å¼å­—ä¸²
         * @returns {string} æ ¼å¼åŒ–çš„æ—¥æœŸå­—ä¸²
         */
        function getFormattedDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * æ ¹æ“šæ’åºé¡å‹å°æ›¸ç±¤é™£åˆ—é€²è¡Œæ’åº
         * @param {Array} bookmarks å¾…æ’åºçš„æ›¸ç±¤é™£åˆ—
         * @param {string} sortType æ’åºé¡å‹å­—ä¸² (key-dir æ ¼å¼)
         * @returns {Array} å·²æ’åºçš„æ›¸ç±¤é™£åˆ—
         */
        function sortBookmarks(bookmarks, sortType) {
            return bookmarks.sort((a, b) => {
                const [key, dir] = sortType.split('-');
                let result = 0;

                switch (key) {
                    case 'date': 
                        // æ—¥æœŸæ’åº
                        result = a.createdAt - b.createdAt;
                        break;
                    case 'title':
                    case 'category':
                    case 'url':
                        // å­—æ¯æ’åº (ä½¿ç”¨ localeCompare é€²è¡Œä¸­æ–‡æ’åº)
                        const valA = a[key] || '';
                        const valB = b[key] || '';
                        result = valA.localeCompare(valB, 'zh-TW', { sensitivity: 'base' });
                        break;
                    default:
                        result = b.createdAt - a.createdAt; // é è¨­ç‚ºæœ€æ–°å„ªå…ˆ
                        break;
                }
                
                // æ ¹æ“šæ–¹å‘æ±ºå®šå‡åºæˆ–é™åº
                return dir === 'desc' ? -result : result;
            });
        }


        /**
         * å¾ localStorage è¼‰å…¥æ›¸ç±¤ï¼Œä¸¦ç‚ºèˆŠè³‡æ–™æˆ–ç©ºæ¬„ä½è£œä¸Šé è¨­å€¼
         */
        function loadBookmarks() {
            try {
                const storedBookmarks = localStorage.getItem(STORAGE_KEY);
                let bookmarks = storedBookmarks ? JSON.parse(storedBookmarks) : [];
                
                let needsUpdate = false;
                bookmarks = bookmarks.map(bookmark => {
                    if (!bookmark.id) {
                        bookmark.id = generateId();
                        needsUpdate = true;
                    }
                    if (!bookmark.category || bookmark.category.trim() === '') {
                        bookmark.category = DEFAULT_CATEGORY;
                        needsUpdate = true;
                    }
                    if (!bookmark.createdAt) {
                        bookmark.createdAt = 0; 
                        needsUpdate = true;
                    }
                    return bookmark;
                });

                if (needsUpdate) {
                    saveBookmarks(bookmarks);
                }

                return bookmarks;

            } catch (error) {
                console.error("è¼‰å…¥æ›¸ç±¤å¤±æ•—:", error);
                showMessage("ç„¡æ³•è¼‰å…¥æ›¸ç±¤è³‡æ–™ï¼Œå¯èƒ½æ˜¯å„²å­˜è³‡æ–™æå£ã€‚", 'error');
                return [];
            }
        }

        /**
         * å°‡æ›¸ç±¤é™£åˆ—å„²å­˜åˆ° localStorage
         */
        function saveBookmarks(bookmarks) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bookmarks));
            } catch (error) {
                console.error("å„²å­˜æ›¸ç±¤å¤±æ•—:", error);
                showMessage("ç„¡æ³•å„²å­˜æ›¸ç±¤è³‡æ–™ï¼Œç€è¦½å™¨å„²å­˜ç©ºé–“å¯èƒ½å·²æ»¿ã€‚", 'error');
            }
        }

        /**
         * å¡«å……åˆ†é¡ç¯©é¸å™¨ä¸‹æ‹‰é¸å–®
         */
        function populateCategoryFilter() {
            const currentFilterValue = categoryFilter.value;
            
            const categories = allBookmarks.map(b => b.category);
            const uniqueCategories = [DEFAULT_CATEGORY, ...new Set(categories)]
                .filter(c => c && c.trim() !== '') 
                .sort();

            categoryFilter.innerHTML = ''; 
            
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'æ‰€æœ‰åˆ†é¡';
            categoryFilter.appendChild(allOption);

            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            if (currentFilterValue) {
                categoryFilter.value = currentFilterValue;
            }
        }

        /**
         * æ ¹æ“šç¯©é¸ã€æ’åºå™¨çš„å€¼è™•ç† allBookmarks ä¸¦é‡æ–°æ¸²æŸ“å…©å€‹è¦–åœ–
         */
        function filterAndRender() {
            const query = searchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value.trim();
            
            // æ±ºå®šæ’åºé¡å‹ï¼šå¦‚æœç•¶å‰æ˜¯è¡¨æ ¼è¦–åœ–ï¼Œå‰‡ä½¿ç”¨è¡¨æ ¼çš„æ’åºç‹€æ…‹ï¼›å¦å‰‡ä½¿ç”¨ä¸‹æ‹‰é¸å–®
            const sortType = currentView === 'table' 
                ? `${currentTableSort.key}-${currentTableSort.dir}`
                : sortSelect.value;
            
            let bookmarksToRender = allBookmarks;

            let isFiltering = false;

            // æ­¥é©Ÿ 1: åˆ†é¡éæ¿¾
            if (selectedCategory !== '') {
                bookmarksToRender = bookmarksToRender.filter(b => b.category === selectedCategory);
                isFiltering = true;
            }

            // æ­¥é©Ÿ 2: é—œéµå­—éæ¿¾
            if (query) {
                isFiltering = true;
                bookmarksToRender = bookmarksToRender.filter(b => 
                    b.title.toLowerCase().includes(query) ||
                    b.url.toLowerCase().includes(query)
                );
            }
            
            // æ­¥é©Ÿ 3: æ’åº
            bookmarksToRender = sortBookmarks(bookmarksToRender, sortType);
            
            // æ­¥é©Ÿ 4: æ¸²æŸ“å…©å€‹è¦–åœ–
            renderBookmarks(bookmarksToRender, isFiltering); // å¡ç‰‡åˆ—è¡¨
            renderTable(bookmarksToRender, isFiltering);     // è¡¨æ ¼ç¸½è¡¨
        }
        
        /**
         * æ¸²æŸ“æ›¸ç±¤åˆ—è¡¨åˆ° DOM (å¡ç‰‡æ¨¡å¼)
         */
        function renderBookmarks(bookmarksToRender, isFiltering = false) {
            bookmarkList.innerHTML = '';

            if (bookmarksToRender.length === 0) {
                emptyStateList.classList.remove('hidden');
                emptyStateList.textContent = isFiltering 
                    ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸ç±¤ã€‚' 
                    : 'ç›®å‰æ²’æœ‰ä»»ä½•æ›¸ç±¤ã€‚è«‹åœ¨ä¸Šæ–¹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ›¸ç±¤ï¼';
                bookmarkList.appendChild(emptyStateList);
                return;
            }

            emptyStateList.classList.add('hidden');

            bookmarksToRender.forEach(bookmark => {
                const id = bookmark.id;
                const displayCategory = bookmark.category || DEFAULT_CATEGORY;
                
                const listItem = document.createElement('li');
                listItem.id = `bookmark-${id}`; 
                // æ›´æ–°å¡ç‰‡æ¨£å¼ï¼šæ›´åœ“æ½¤ã€æ›´æŸ”å’Œçš„é™°å½±å’Œè¼•å¾®çš„æ‡¸åœç¸®æ”¾
                listItem.className = 'p-5 bg-white border border-gray-100 rounded-xl shadow-md hover:shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.005]';
                
                // --- é¡¯ç¤ºæ¨¡å¼ (Display View) ---
                const displayDiv = document.createElement('div');
                displayDiv.id = `display-view-${id}`;
                displayDiv.className = 'flex items-start justify-between';

                const encodedTitle = bookmark.title.replace(/"/g, '&quot;');
                const encodedUrl = bookmark.url.replace(/"/g, '&quot;');
                
                const linkContent = `
                    <div class="flex-1 min-w-0 pr-4">
                        <div class="flex items-center space-x-2 mb-1">
                            <a href="${encodedUrl}" target="_blank" rel="noopener noreferrer" 
                               class="text-lg font-medium text-primary-dark truncate hover:text-primary-light transition duration-150">
                                ${bookmark.title}
                            </a>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 shadow-sm">
                                ${displayCategory}
                            </span>
                        </div>
                        <span class="text-sm text-gray-500 truncate block">${bookmark.url}</span>
                        <span class="text-xs text-gray-400 mt-1 block">å»ºç«‹æ–¼: ${formatTimestamp(bookmark.createdAt)}</span>
                    </div>
                `;
                displayDiv.innerHTML = linkContent;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-2 flex-shrink-0 pt-1';
                
                const editButton = document.createElement('button');
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                                          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-7.5 7.5a1 1 0 00-.288.815l-.483 2.93a1 1 0 00.187.892l.707.707a1 1 0 00.707 0l.707-.707a1 1 0 00.207-.584l.412-2.146a1 1 0 00-.207-.75l-2.121-2.121z" />
                                        </svg>`;
                editButton.title = 'ç·¨è¼¯';
                editButton.className = 'p-2 rounded-full hover:bg-indigo-50 transition duration-150 ease-in-out';
                editButton.addEventListener('click', () => {
                    toggleEditMode(id, true);
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                        </svg>`;
                deleteButton.title = 'åˆªé™¤';
                deleteButton.className = 'p-2 rounded-full hover:bg-red-50 transition duration-150 ease-in-out';
                deleteButton.addEventListener('click', () => {
                    deleteBookmark(id);
                });

                buttonContainer.appendChild(editButton);
                buttonContainer.appendChild(deleteButton);
                displayDiv.appendChild(buttonContainer);
                
                listItem.appendChild(displayDiv);

                // --- ç·¨è¼¯æ¨¡å¼ (Edit View) ---
                const editForm = document.createElement('form');
                editForm.id = `edit-form-${id}`;
                editForm.className = 'space-y-3 hidden pt-3'; 
                editForm.onsubmit = (e) => { e.preventDefault(); updateBookmark(e, id); };
                
                editForm.innerHTML = `
                    <div class="flex space-x-2">
                        <input type="text" id="edit-title-${id}" value="${encodedTitle}" required 
                               placeholder="æ›¸ç±¤åç¨± (æœ€å¤š ${MAX_TITLE_LENGTH} å­—å…ƒ)" class="w-1/2 px-3 py-1 border border-gray-300 rounded-xl text-sm focus:ring-primary-dark focus:border-primary-dark">
                        <input type="text" id="edit-category-${id}" value="${displayCategory.replace(/"/g, '&quot;')}" 
                               placeholder="åˆ†é¡/æ¨™ç±¤ (æœ€å¤š ${MAX_CATEGORY_LENGTH} å­—å…ƒ)" class="w-1/2 px-3 py-1 border border-gray-300 rounded-xl text-sm focus:ring-primary-dark focus:border-primary-dark">
                    </div>
                    <div>
                        <label for="edit-url-${id}" class="sr-only">ç¶²å€</label>
                        <input type="url" id="edit-url-${id}" value="${encodedUrl}" required 
                               placeholder="ç¶²å€ (å¿…é ˆåŒ…å« http:// æˆ– https://)" class="w-full px-3 py-1 border border-gray-300 rounded-xl text-sm focus:ring-primary-dark focus:border-primary-dark">
                    </div>
                    <div class="flex justify-end space-x-2 pt-2">
                        <button type="button" onclick="window.toggleEditMode('${id}', false)" 
                                class="px-3 py-1 text-sm font-medium text-gray-700 border border-gray-300 rounded-full hover:bg-gray-100 transition duration-150 transform hover:scale-[1.05]">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" 
                                class="px-3 py-1 text-sm font-medium text-white bg-primary-dark rounded-full hover:bg-primary-light transition duration-150 transform hover:scale-[1.05]">
                            å„²å­˜ä¿®æ”¹
                        </button>
                    </div>
                `;
                
                listItem.appendChild(editForm);
                bookmarkList.appendChild(listItem);
            });
        }
        
        /**
         * æ¸²æŸ“æ›¸ç±¤ç¸½è¡¨åˆ° DOM (è¡¨æ ¼æ¨¡å¼)
         */
        function renderTable(bookmarksToRender, isFiltering = false) {
            bookmarkTableBody.innerHTML = '';
            
            // è™•ç†è¡¨æ ¼ç©ºç™½ç‹€æ…‹
            const tableContainer = document.getElementById('bookmark-table-container');
            if (bookmarksToRender.length === 0) {
                emptyStateTable.classList.remove('hidden');
                tableContainer.classList.add('flex', 'flex-col', 'items-center', 'justify-center');
                return;
            }

            emptyStateTable.classList.add('hidden');
            tableContainer.classList.remove('flex', 'flex-col', 'items-center', 'justify-center');

            bookmarksToRender.forEach((bookmark, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50 transition duration-100' : 'bg-gray-50 hover:bg-gray-100 transition duration-100';

                // æ›¸ç±¤åç¨± (Title)
                const titleTd = document.createElement('td');
                titleTd.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs';
                titleTd.innerHTML = `<a href="${bookmark.url}" target="_blank" rel="noopener noreferrer" 
                                       class="text-primary-dark hover:text-primary-light transition duration-150">${bookmark.title}</a>`;
                tr.appendChild(titleTd);
                
                // ç¶²å€ (URL)
                const urlTd = document.createElement('td');
                urlTd.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs';
                urlTd.textContent = bookmark.url;
                tr.appendChild(urlTd);
                
                // åˆ†é¡ (Category)
                const categoryTd = document.createElement('td');
                categoryTd.className = 'px-4 py-3 whitespace-nowrap text-xs text-gray-700 w-32';
                categoryTd.textContent = bookmark.category || DEFAULT_CATEGORY;
                tr.appendChild(categoryTd);

                // å»ºç«‹æ—¥æœŸ (CreatedAt)
                const dateTd = document.createElement('td');
                dateTd.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500 w-40';
                dateTd.textContent = formatTimestamp(bookmark.createdAt);
                tr.appendChild(dateTd);

                bookmarkTableBody.appendChild(tr);
            });
        }

        /**
         * è™•ç†è¡¨æ ¼æ¨™é ­é»æ“Šäº‹ä»¶ (è¡¨æ ¼æ’åº)
         */
        function handleTableSort(e) {
            const th = e.currentTarget;
            const key = th.dataset.sortKey;
            let dir = th.dataset.sortDir;

            // ç§»é™¤æ‰€æœ‰æ¨™é ­çš„ active ç‹€æ…‹
            tableHeaders.forEach(header => {
                header.classList.remove('active-sort');
                header.querySelector('.sort-icon').innerHTML = '&#x2195;'; // é è¨­é›™ç®­é ­
                header.dataset.sortDir = 'none'; // é‡ç½®å…¶ä»–æ¨™é ­çš„æ–¹å‘
            });

            // åˆ¤æ–·æ–°çš„æ’åºæ–¹å‘
            if (key === currentTableSort.key) {
                // å¦‚æœé»æ“Šçš„æ˜¯åŒä¸€æ¬„ï¼Œåˆ‡æ›æ–¹å‘
                dir = currentTableSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                // å¦‚æœé»æ“Šçš„æ˜¯æ–°çš„ä¸€æ¬„ï¼Œé è¨­ç‚ºé™åº (desc) æˆ–ä¾ key è¨­å®š
                dir = key === 'title' || key === 'category' || key === 'url' ? 'asc' : 'desc';
            }

            // æ›´æ–°è¡¨æ ¼æ’åºç‹€æ…‹
            currentTableSort = { key, dir };

            // æ›´æ–°æ¨™é ­çš„è¦–è¦ºæ•ˆæœ
            th.classList.add('active-sort');
            th.dataset.sortDir = dir;
            th.querySelector('.sort-icon').innerHTML = dir === 'asc' ? '&#x2191;' : '&#x2193;'; // é¡¯ç¤ºå–®å‘ç®­é ­
            
            // é‡æ–°ç¯©é¸å’Œæ¸²æŸ“ (filterAndRender æœƒæ ¹æ“š currentTableSort é€²è¡Œæ’åº)
            filterAndRender();
        }


        /**
         * å°‡æ‰€æœ‰æ›¸ç±¤åŒ¯å‡ºç‚º CSV æ ¼å¼ (é©ç”¨æ–¼ Google Sheets æˆ– Excel)
         */
        function exportToCSV() {
            if (allBookmarks.length === 0) {
                showMessage("æ›¸ç±¤åˆ—è¡¨ç‚ºç©ºï¼Œæ²’æœ‰è³‡æ–™å¯ä¾›åŒ¯å‡ºã€‚", 'error');
                return;
            }

            // CSV æ¨™é ­
            const headers = ["Title", "URL", "Category", "CreatedAt"];
            const csvRows = [];
            csvRows.push(headers.join(',')); // åŠ å…¥æ¨™é ­

            allBookmarks.forEach(bookmark => {
                // è™•ç†å¯èƒ½åŒ…å«é€—è™Ÿæˆ–å¼•è™Ÿçš„å­—ä¸²ï¼Œä¸¦ç¢ºä¿ä½¿ç”¨æ¨™æº–æ ¼å¼
                const escapeCSV = (str) => {
                    if (!str) return '""';
                    // ç§»é™¤æ›è¡Œç¬¦ä¸¦å°‡é›™å¼•è™Ÿæ›¿æ›ç‚ºå…©å€‹é›™å¼•è™Ÿï¼Œç„¶å¾Œç”¨é›™å¼•è™ŸåŒ…ä½æ•´å€‹å­—ä¸²
                    let s = String(str).replace(/\n/g, ' ').replace(/"/g, '""');
                    return `"${s}"`;
                };

                const row = [
                    escapeCSV(bookmark.title),
                    escapeCSV(bookmark.url),
                    escapeCSV(bookmark.category || DEFAULT_CATEGORY),
                    escapeCSV(formatTimestamp(bookmark.createdAt))
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const dataBlob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_export_${Date.now()}.csv`;
            
            // è§¸ç™¼é»æ“Šä¸¦æ¸…é™¤
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`æˆåŠŸåŒ¯å‡º ${allBookmarks.length} å€‹æ›¸ç±¤åˆ° ${a.download}ã€‚`, 'success');
        }


        /**
         * åˆ‡æ›è¦–åœ–æ¨¡å¼
         * @param {string} view 'list' æˆ– 'table'
         */
        window.toggleView = function(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰éˆ•è¦–è¦ºæ•ˆæœ
            const listBtn = document.getElementById('view-list-btn');
            const tableBtn = document.getElementById('view-table-btn');

            if (view === 'list') {
                bookmarkListView.classList.remove('hidden');
                bookmarkTableView.classList.add('hidden');
                listControls.classList.remove('hidden');

                listBtn.classList.add('border-primary-dark', 'text-primary-dark');
                listBtn.classList.remove('text-gray-500', 'hover:border-gray-300', 'border-transparent');
                
                tableBtn.classList.remove('border-primary-dark', 'text-primary-dark');
                tableBtn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                
                // åˆ‡æ›å›åˆ—è¡¨è¦–åœ–æ™‚ï¼Œå°‡æ’åºç‹€æ…‹æ¢å¾©åˆ°ä¸‹æ‹‰é¸å–®çš„å€¼
                sortSelect.value = `${currentTableSort.key}-${currentTableSort.dir}`; 

            } else {
                bookmarkListView.classList.add('hidden');
                bookmarkTableView.classList.remove('hidden');
                listControls.classList.add('hidden'); // è¡¨æ ¼è¦–åœ–ä¸éœ€è¦åˆ—è¡¨çš„ç¯©é¸/æ’åºæ§åˆ¶é …

                tableBtn.classList.add('border-primary-dark', 'text-primary-dark');
                tableBtn.classList.remove('text-gray-500', 'hover:border-gray-300', 'border-transparent');
                
                listBtn.classList.remove('border-primary-dark', 'text-primary-dark');
                listBtn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');

                // ç¢ºä¿è¡¨æ ¼æ’åºç‹€æ…‹ç”Ÿæ•ˆ
            }

            // é‡æ–°æ¸²æŸ“ï¼Œä»¥æ‡‰ç”¨æ–°çš„æ’åºç‹€æ…‹ (å³ä½¿è¦–åœ–åˆ‡æ›ï¼Œæ’åºä¹Ÿå¯èƒ½æ”¹è®Š)
            filterAndRender(); 
        }

        // ç¶å®šç·¨è¼¯æ¨¡å¼åˆ‡æ› (ä¿æŒåŸæœ‰çš„ window scope å‡½æ•¸)
        window.toggleEditMode = function(id, isEditing) {
            const displayDiv = document.getElementById(`display-view-${id}`);
            const editForm = document.getElementById(`edit-form-${id}`);

            if (displayDiv && editForm) {
                if (isEditing) {
                    displayDiv.classList.add('hidden');
                    editForm.classList.remove('hidden');
                } else {
                    displayDiv.classList.remove('hidden');
                    editForm.classList.add('hidden');
                }
            }
        }
        
        // --- æ ¸å¿ƒ CRUD åŠŸèƒ½ ---
        function addBookmark(e) {
            e.preventDefault();

            const url = urlInput.value.trim();
            const title = titleInput.value.trim();
            let category = categoryInput.value.trim();
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showMessage('ç¶²å€å¿…é ˆä»¥ http:// æˆ– https:// é–‹é ­');
                return;
            }
            if (title.length > MAX_TITLE_LENGTH || title === '') {
                showMessage(`æ›¸ç±¤åç¨±å¤ªé•·æˆ–ç‚ºç©ºï¼Œè«‹å‹¿è¶…é ${MAX_TITLE_LENGTH} å€‹å­—å…ƒã€‚`);
                return;
            }
            if (category.length > MAX_CATEGORY_LENGTH) {
                showMessage(`åˆ†é¡åç¨±å¤ªé•·ï¼Œè«‹å‹¿è¶…é ${MAX_CATEGORY_LENGTH} å€‹å­—å…ƒã€‚`);
                return;
            }

            if (category === '') {
                category = DEFAULT_CATEGORY;
            }

            const isDuplicate = allBookmarks.some(b => b.url === url);
            if (isDuplicate) {
                showMessage('æ­¤ç¶²å€çš„æ›¸ç±¤å·²ç¶“å­˜åœ¨ï¼');
                return;
            }

            const newBookmark = {
                id: generateId(),
                title: title,
                url: url,
                category: category,
                createdAt: Date.now()
            };

            allBookmarks.push(newBookmark);
            saveBookmarks(allBookmarks);
            
            populateCategoryFilter();
            filterAndRender();

            bookmarkForm.reset();
            showMessage('æ›¸ç±¤æ–°å¢æˆåŠŸï¼', 'success');
        }

        function updateBookmark(e, id) {
            const newTitle = document.getElementById(`edit-title-${id}`).value.trim();
            const newUrl = document.getElementById(`edit-url-${id}`).value.trim();
            let newCategory = document.getElementById(`edit-category-${id}`).value.trim();

            if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
                showMessage('æ›´æ–°å¤±æ•—ï¼šç¶²å€å¿…é ˆä»¥ http:// æˆ– https:// é–‹é ­');
                return;
            }
            if (newTitle.length > MAX_TITLE_LENGTH || newTitle === '') {
                showMessage(`æ›´æ–°å¤±æ•—ï¼šæ›¸ç±¤åç¨±å¤ªé•·æˆ–ç‚ºç©ºï¼Œè«‹å‹¿è¶…é ${MAX_TITLE_LENGTH} å€‹å­—å…ƒã€‚`);
                return;
            }
            if (newCategory.length > MAX_CATEGORY_LENGTH) {
                showMessage(`æ›´æ–°å¤±æ•—ï¼šåˆ†é¡åç¨±å¤ªé•·ï¼Œè«‹å‹¿è¶…é ${MAX_CATEGORY_LENGTH} å€‹å­—å…ƒã€‚`);
                return;
            }

            if (newCategory === '') {
                newCategory = DEFAULT_CATEGORY;
            }

            let updated = false;

            const newBookmarks = allBookmarks.map(bookmark => {
                if (bookmark.id === id) {
                    const isOtherDuplicate = allBookmarks.some(b => b.url === newUrl && b.id !== id);
                    if (isOtherDuplicate) {
                        showMessage('æ›´æ–°å¤±æ•—ï¼šæ–°çš„ç¶²å€èˆ‡ç¾æœ‰å…¶ä»–æ›¸ç±¤é‡è¤‡ï¼');
                        updated = false;
                        return bookmark; 
                    }
                    
                    bookmark.title = newTitle;
                    bookmark.url = newUrl;
                    bookmark.category = newCategory; 
                    updated = true;
                }
                return bookmark;
            });
            allBookmarks = newBookmarks; 

            if (updated) {
                saveBookmarks(allBookmarks);
                populateCategoryFilter(); 
                filterAndRender(); 
                showMessage('æ›¸ç±¤å·²æˆåŠŸæ›´æ–°ã€‚', 'success');
            } else {
                toggleEditMode(id, false);
            }
        }

        function deleteBookmark(idToDelete) {
            const updatedBookmarks = allBookmarks.filter(bookmark => bookmark.id !== idToDelete);

            if (updatedBookmarks.length !== allBookmarks.length) {
                allBookmarks = updatedBookmarks; 
                saveBookmarks(allBookmarks);
                populateCategoryFilter(); 
                filterAndRender(); 
                showMessage('æ›¸ç±¤å·²æˆåŠŸåˆªé™¤ã€‚', 'success');
            }
        }
        
        // --- è‡ªå‹•å¡«å……å’ŒåŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½ (ä¿æŒåŸæœ‰é‚è¼¯) ---
        function autoFillDetails() {
            const url = urlInput.value.trim();
            if (url === '' || (!url.startsWith('http://') && !url.startsWith('https://'))) {
                showMessage('è«‹å…ˆè¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„ç¶²å€ï¼', 'error');
                return;
            }

            categoryInput.value = getFormattedDate();
            showMessage(`åˆ†é¡å·²è¨­ç‚ºç•¶å‰æ—¥æœŸ: ${categoryInput.value}`, 'success');
            
            titleInput.value = "æ­£åœ¨å˜—è©¦æå–åç¨±...";
            
            setTimeout(() => {
                try {
                    const urlObject = new URL(url);
                    let hostname = urlObject.hostname;
                    hostname = hostname.replace(/^www\./i, '');
                    let titleSuggestion = hostname.split('.')[0]; 

                    if (titleSuggestion.trim() === '') {
                        titleSuggestion = `[ç¶²å€è§£æå¤±æ•—] è«‹æ‰‹å‹•è¼¸å…¥`;
                    } else {
                         titleSuggestion = titleSuggestion.charAt(0).toUpperCase() + titleSuggestion.slice(1);
                    }

                    titleInput.value = titleSuggestion;
                    showMessage("ç¶²å€åç¨±å·²å¾ URL æˆåŠŸæå–ã€‚", 'success');
                    
                } catch (e) {
                    titleInput.value = `[æ ¼å¼éŒ¯èª¤] è«‹æ‰‹å‹•æ ¡æ­£æˆ–æª¢æŸ¥ç¶²å€`;
                    showMessage("ç¶²å€æ¨™é¡Œè‡ªå‹•å¡«å……å¤±æ•—ï¼ˆç¶²å€æ ¼å¼éŒ¯èª¤ï¼‰ã€‚", 'error');
                }
            }, 500); 
        }

        function exportBookmarks() {
            if (allBookmarks.length === 0) {
                showMessage("æ›¸ç±¤åˆ—è¡¨ç‚ºç©ºï¼Œæ²’æœ‰è³‡æ–™å¯ä¾›åŒ¯å‡ºã€‚", 'error');
                return;
            }

            const dataStr = JSON.stringify(allBookmarks, null, 2); 
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_export_${Date.now()}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`æˆåŠŸåŒ¯å‡º ${allBookmarks.length} å€‹æ›¸ç±¤åˆ° ${a.download}ã€‚`, 'success');
        }

        function handleImportFile(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    processImportedData(importedData);
                } catch (error) {
                    console.error("è§£æ JSON å¤±æ•—:", error);
                    showMessage('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚', 'error');
                }
            };
            reader.readAsText(file);
        }

        function processImportedData(importedData) {
            if (!Array.isArray(importedData)) {
                showMessage('åŒ¯å…¥å¤±æ•—ï¼šJSON å…§å®¹ä¸æ˜¯ä¸€å€‹æ›¸ç±¤é™£åˆ—ã€‚', 'error');
                return;
            }

            let importCount = 0;
            let duplicateCount = 0;
            const existingUrls = new Set(allBookmarks.map(b => b.url));
            const newBookmarks = [];

            importedData.forEach(item => {
                if (item && item.title && item.url) {
                    const cleanUrl = item.url.trim();
                    
                    if (existingUrls.has(cleanUrl)) {
                        duplicateCount++;
                        return;
                    }
                    
                    if (item.title.length > MAX_TITLE_LENGTH || (item.category && item.category.length > MAX_CATEGORY_LENGTH)) {
                         console.warn("ç•¥éåŒ¯å…¥é …ç›®: è³‡æ–™é•·åº¦è¶…éé™åˆ¶ã€‚", item);
                         return;
                    }

                    const newBookmark = {
                        id: generateId(),
                        title: item.title,
                        url: cleanUrl,
                        category: (item.category && item.category.trim() !== '') ? item.category : DEFAULT_CATEGORY,
                        createdAt: item.createdAt || 0
                    };
                    
                    newBookmarks.push(newBookmark);
                    existingUrls.add(cleanUrl);
                    importCount++;
                } else {
                    console.warn("ç•¥éç„¡æ•ˆçš„åŒ¯å…¥é …ç›®:", item);
                }
            });

            if (importCount > 0) {
                allBookmarks = [...allBookmarks, ...newBookmarks]; 
                saveBookmarks(allBookmarks);
                populateCategoryFilter(); 
                filterAndRender(); 
                showMessage(`æˆåŠŸåŒ¯å…¥ ${importCount} å€‹æ›¸ç±¤ã€‚å·²ç•¥é ${duplicateCount} å€‹é‡è¤‡é …ç›®ã€‚`, 'success');
            } else if (duplicateCount > 0) {
                 showMessage(`åŒ¯å…¥å®Œæˆï¼Œä½†æ‰€æœ‰é …ç›®çš†ç‚ºé‡è¤‡ï¼Œå…±ç•¥é ${duplicateCount} å€‹é‡è¤‡é …ç›®ã€‚`, 'error');
            } else {
                showMessage('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„æ›¸ç±¤è³‡æ–™ã€‚', 'error');
            }
            
            importFile.value = '';
        }
        
        /**
         * åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ï¼šè¼‰å…¥è³‡æ–™ä¸¦è¨­å®šäº‹ä»¶ç›£è½å™¨
         */
        function initializeApp() {
            // 1. è¼‰å…¥è³‡æ–™ä¸¦è¨­å®šå…¨åŸŸé™£åˆ—
            allBookmarks = loadBookmarks();
            
            // 2. å¡«å……åˆ†é¡ç¯©é¸å™¨
            populateCategoryFilter();
            
            // 3. åˆå§‹æ¸²æŸ“ (é è¨­ç‚ºåˆ—è¡¨è¦–åœ–)
            filterAndRender(); 
            window.toggleView('list');

            // 4. ç¶å®šä¸»è¦äº‹ä»¶ç›£è½å™¨
            bookmarkForm.addEventListener('submit', addBookmark);
            searchInput.addEventListener('input', filterAndRender);
            categoryFilter.addEventListener('change', filterAndRender);
            // åˆ—è¡¨æ’åºä¸‹æ‹‰é¸å–®æ”¹è®Šæ™‚ï¼Œé‡è¨­è¡¨æ ¼æ’åºç‹€æ…‹ä¸¦æ¸²æŸ“
            sortSelect.addEventListener('change', () => {
                currentTableSort = { key: 'date', dir: 'desc' }; // é‡ç½®è¡¨æ ¼æ’åº
                filterAndRender();
            }); 
            
            // 5. ç¶å®šåŒ¯å…¥/åŒ¯å‡ºäº‹ä»¶ç›£è½å™¨
            exportButton.addEventListener('click', exportBookmarks);
            importFile.addEventListener('change', handleImportFile); 
            exportCsvButton.addEventListener('click', exportToCSV); // NEW: åŒ¯å‡º CSV

            // 6. ç¶å®šè‡ªå‹•å¡«å……æŒ‰éˆ•äº‹ä»¶
            autofillButton.addEventListener('click', autoFillDetails);

            // 7. ç¶å®šè¡¨æ ¼æ¨™é ­æ’åºäº‹ä»¶ (NEW)
            tableHeaders.forEach(th => {
                th.addEventListener('click', handleTableSort);
            });
        }

        // åˆå§‹åŒ–ï¼šé é¢è¼‰å…¥æ™‚è¼‰å…¥ä¸¦æ¸²æŸ“æ›¸ç±¤åˆ—è¡¨
        window.onload = initializeApp;

    </script>

</body>
</html>